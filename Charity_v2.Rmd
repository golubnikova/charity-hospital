---
title: "Chrity_v2"
author: "PotapenkoEugene"
date: "2022-11-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load preprocessed data
source("CharityHospital_R_2022-11-02_1448.R")

if(!require('Hmisc')) install.packages('Hmisc') ; library(Hmisc)
if(!require('tidyverse')) install.packages('tidyverse') ; library(tidyverse)
if(!require('data.table')) install.packages('data.table') ; library(data.table)
if(!require('dplyr')) install.packages('dplyr') ; library(dplyr)
if(!require('magrittr')) install.packages('magrittr') ; library(magrittr)
if(!require('eeptools')) install.packages('eeptools') ; library(eeptools)
if(!require('naniar')) install.packages('naniar') ; library(naniar)
if(!require('fastDummies')) install.packages('fastDummies') ; library(fastDummies)
if(!require('forcats')) install.packages('forcats') ; library(forcats)

if(!require('wesanderson')) install.packages('wesanderson') ; library(wesanderson)

if(!require('ggpubr')) install.packages('ggpubr') ; library(ggpubr)
if(!require('grid')) install.packages('grid') ; library(grid)
if(!require('gridExtra')) install.packages('gridExtra') ; library(gridExtra)
if(!require('ggplotify')) install.packages('ggplotify') ; library(ggplotify)
if(!require('ggmosaic')) install.packages('ggmosaic') ; library(ggmosaic)

if(!require('shiny')) install.packages('shiny') ; library(shiny)

### FUNC
doc_vars_mutate <-
  function(df, col.bool, col.reason){
  df %>%
    dplyr::rename(target.bool = !!col.bool, target.reason = !!col.reason) %>%
    # Move some values from "bool" to reason
    dplyr::mutate(target.reason = as.factor(case_when(target.bool == 'восстанавливает' ~ target.bool,
                                            target.bool == 'заложен' ~ target.bool,
                                            TRUE ~ target.reason))) %>%
    # "bool" to bool
    dplyr::mutate(target.bool = as.factor(case_when(target.bool %in% c('есть') ~ T,
                                          target.bool %in% c('восстанавливает',
                                                               'заложен',
                                                               'нет')~ F,
                                          target.bool == 'нет данных' ~ NA))) %>%
    dplyr::rename_with(~ c(col.bool, col.reason), all_of(c('target.bool', 'target.reason')))
  }

sum_rowwise_vars <- 
  function(df, prefix, NAstring){
      df %>%
        dplyr::filter(is.na(redcap_repeat_instance)) %>% # keep only info rows of records
        dplyr::select(record_id, starts_with(prefix)) %>%
        dplyr::mutate_at(vars(starts_with(prefix)), function(x) na_if(x, NAstring)) %>% # replace ОТРИЦАЕТ with NA
        # Calculate number of ch ds per patient
        dplyr::mutate_at(vars(starts_with(prefix)), function(x) ifelse(!is.na(x), T, F)) %>%
        rowwise() %T>% 
        {varname <<- paste0(prefix, '.number')} %>% # save new varname
        mutate(!!varname := sum(cur_data()) - record_id) %>% # just minus record_id (simpliest way)
        dplyr::select(!!varname)
        
  }

first_last_dinamics <- function(vec){
      combinations <-
        vec %>%
          str_split(., '\\|') %>%
          do.call(c, .) %>% 
          unique %>%
          .[. != 'NA'] %>% # drop NA
          c(., .) %>%
          combn(2) %>% 
          t %>%
          as.data.frame %>% 
          unique %>%
          rowwise() %>%
          dplyr::mutate(Rangs = paste0(V1, ' -> ', V2)) %>%
          .$Rangs
          
      
      vec %>%
        str_split(., '\\|') %>%
        sapply(function(x) {
          x = x[x != 'NA']
          if(length(x) == 0) {
            return(NA)
            } else{
              x = ifelse(x[1] == x[length(x)],
                                   x[1],
                                   paste0(x[1], ' -> ', x[length(x)]))
            }
        }
          )
}

# Postprocessing
data <-
  data %>%
  # Rename some vars
  dplyr::rename(Observation = redcap_repeat_instrument.factor) %>% 
  # Drop useless vars 
  dplyr::select(-(starts_with('complaint_lite') & ends_with('.factor'))) %>%
  # Split some vars
  separate(id_status.factor, into = c('id_status.factor.bool', 'id_status.factor.reason'), sep = '/') %>% 
  separate(oms_status.factor, into = c('oms_status.factor.bool', 'oms_status.factor.reason'), sep = '/') %>% 
  separate(sn_status.factor, into = c('sn_status.factor.bool', 'sn_status.factor.reason'), sep = '/') %>%
  # Mutate docs vars
  doc_vars_mutate('id_status.factor.bool', 'id_status.factor.reason') %>%
  doc_vars_mutate('oms_status.factor.bool', 'oms_status.factor.reason') %>%
  doc_vars_mutate('sn_status.factor.bool', 'sn_status.factor.reason') %>%
  # Encode homeless
  dplyr::mutate(Homeless = case_when(where_homless %in%  c(1, 14, 16, 6, 11) ~ 'уличный',
                                     where_homless %in% c(17, 2, 3, 4, 12, 5, 6, 15, 7) ~ 'условно уличный',
                                     where_homless %in% c(8, 9, 13) ~ 'домашний', 
                                     where_homless == 10 ~ 'NA')) #TODO или наоборот ПРИРАВНЯТЬ NA к отказу от ответа
```

# Load 
Load data from 
~/Orthonectida/Projects/Biostatistic/Biostat_2022/scripts/CharityHospital_R_2022-11-02_1448.r

# Classified vars
```{r}
# Base vars:
base_vars.factor = c('gender.factor', 'age.group',
              # Docs
              'id_status.factor.reason', 'oms_status.factor.reason', 'sn_status.factor.reason',
              # Additctions
              'nicotin.factor', 'alcogolic.factor', 'narco.factor', 'ne_narco.factor')

base_vars.bool = c('id_status.factor.bool', 'oms_status.factor.bool', 'sn_status.factor.bool')

quant_vars = c('ObsNum', 'age.actual')


# Dummy variables:
dummy_vars_raw = c('Observation', 'Homeless',
               'ds_icd_1.factor', 'ds_icd_2.factor', 'ds_icd_3.factor', 
               'etest_hiv.factor', 'etest_hbsag.factor', 'etest_hcv.factor', 'etest_lues.factor', 'etest_covid19.factor')
dummy_vars_already <- c('complaint_lite')

# Dinamic variables
dinamic_vars = c('Observation', 'Homeless')
```

# Transform data
```{r warning = F}
## Transform BirthDate to actual age (26.11.2022)
data$age.actual[!is.na(data$date_bd)] <- 
  age_calc(as.Date(data$date_bd[!is.na(data$date_bd)]),
           Sys.Date(),
           units = 'years') %>%
  floor

# Age group
data <-
  data %>%
  dplyr::mutate(
    age.group = case_when(
      age.actual < 18 ~ "<18 (несовершеннолетние)",
      age.actual >= 18 & age.actual < 45 ~ "18-44 (молодой возраст)",
      age.actual >= 45 & age.actual < 60 ~ "45-59 (средний возраст)",
      age.actual >= 60 & age.actual < 75 ~ "60-74 (пожилой возраст)",
      age.actual >= 75 ~ "75+ (старческий возраст)"
    )
  )
data$age.group <- factor(data$age.group, levels = sort(unique(data$age.group)))

```


# Processing of each type of vars
```{r}
# Dinamic vars (should be processed before dummy)
data_dinamic <-
  data %>%
    dplyr::select(record_id, dinamic_vars) %>%
    dplyr::group_by(record_id) %>%
    dplyr::summarise_all(function(x) paste(x, collapse = '|')) %>%
    dplyr::rename_all(function(x) ifelse(x != 'record_id', paste0(x, '.dinamic'), x)) %>%
    dplyr::mutate_at(vars(ends_with('.dinamic')), 
                     function(x) first_last_dinamics(x) %>% replace_na('Нет данных') %>% as.factor)

# Renew names of dinamic vars with dinamic suffix
dinamic_vars = paste0(dinamic_vars, '.dinamic')

# Proccess dummy vars (drop original dummy vars)
data_dummy <-
  data %>%
  dummy_cols(remove_first_dummy = F, ignore_na = T,
             select_columns = dummy_vars_raw) %>%
  dplyr::select(-dummy_vars_raw) %>% # remove original vars
  # Rename dummy vars already (for further join with original df)
  dplyr::rename_at(vars(starts_with(dummy_vars_already)), ~paste0('.',.)) %>%
  dplyr::select(record_id, starts_with(c(dummy_vars_raw, paste0('.', dummy_vars_already)), ignore.case = F)) %>% # select new vars + already dumm vars
  dplyr::group_by(record_id) %>%
  dplyr::summarise_all(function(x) sum(x, na.rm =T)) %>%
  dplyr::ungroup() %>%
  dplyr::select_if(function(x) sum(x, na.rm = T) != 0) # drop zero sum
# Add new dummied variables to list of quant vars
dummy_quant_vars = data_dummy %>% colnames %>% .[-1] # drom record_id

# Process quantative vars (among observation)
data_collapse <-
  data %>%
    dplyr::group_by(record_id) %>%
    dplyr::summarise(ObsNum = ifelse(n() == 1, 1, n() - 1))

# Rowwise vars
data_rowwise <- 
  data %>%
  dplyr::filter(is.na(Observation)) %>% # Keep only informative rows
  dplyr::select(record_id) %>%
  cbind(sum_rowwise_vars(data, 'ch_ds', 'отрицает')) # bind ID with rowwise vars

# Add rowwise new variables to quant
quant_vars = c(quant_vars, data_rowwise %>% dplyr::select(ends_with('.number')) %>% colnames)
```


# Basic stats
```{r}
selected_vars <- c(base_vars.bool, base_vars.factor, quant_vars, dummy_quant_vars, dinamic_vars)
##
data_done <-
  data %>%
  # filter out rows without base info
  dplyr::filter(is.na(redcap_repeat_instrument)) %>% 
  # Join with summed dummy vars
  right_join(data_dummy, by = 'record_id') %>%
  # Join with quant vars
  right_join(data_collapse, by = 'record_id') %>%
  # Join with rowwise vars
  right_join(data_rowwise, by = 'record_id') %>% 
  # Join with dinamic vars
  right_join(data_dinamic, by = 'record_id') %>%
  dplyr::select(record_id, all_of(selected_vars))
```

# HandMade analyses
``{r fig.width = 7}
# Process
# Homeless relevel
lvls = levels(data_done$Homeless.dinamic)
data_done$Homeless.dinamic <- factor(data_done$Homeless.dinamic, 
                                        levels = lvls[order(sapply(lvls, nchar))])

patient_profile <-
  data_done %>%
  dplyr::select(record_id, gender.factor, age.group,
                Homeless.dinamic, id_status.factor.bool,
                oms_status.factor.bool, sn_status.factor.bool,
                ObsNum) #%>%
  # dplyr::mutate(record_id = factor(record_id, levels = record_id))


patient_profile %>%
  dplyr::select(age.group, gender.factor) %>%
  na.omit %>%
  ggplot(aes(age.group, gender.factor)) +
  geom_mosaic(aes(x = product(age.group, gender.factor)), fill = wes_palettes$BottleRocket1[1]) +
  geom_mosaic_text(aes(x = product(age.group, gender.factor), label = after_stat(.wt)), as.label=TRUE)


patient_profile %>%
  # as.data.table %>%
  # melt.data.table(id.vars = 'record_id') %>%
  # left_join(data_done %>% dplyr::select(record_id, age.group), by = 'record_id') %>%
  #Plot
  ggplot(aes(value, variable, group = age.group)) +
    geom_bar(stat='identity', position = 'dodge')
  
patient_age_num <-
  patient_profile %>%
    dplyr::group_by(age.group) %>%
    dplyr::summarise(., across(where(is.numeric), sum)) %>% 
    dplyr::select(-record_id)

patient_age_factor <-
  patient_profile %>%
  dplyr::select(-ObsNum) %>%
  as.data.table %>%
  melt.data.table(id.vars = 'record_id') %>%
  left_join(data_done %>% dplyr::select(record_id, age.group), by = 'record_id') %>%
  dplyr::select(-record_id) %>%
  dplyr::group_by(age.group, variable, value) %>% 
  count

patient_age_factor %>%
  left_join(patient_age_num, by = 'age.group') %>%
  dplyr::filter(variable != 'age.group') %>%
  na.omit %>%
  #Plot
  ggplot(aes(x = n, y = value, fill = age.group)) +
  geom_bar(stat='identity', position = 'dodge') + 
  facet_grid(rows = vars(variable))

patient_profile %>%
  as.data.table %>%
  dplyr::select(-age.group, -ObsNum) %>%
  melt.data.table(id.vars = 'record_id') %>%
  left_join(data_done %>% dplyr::select(record_id, age.group), by = 'record_id') %>%
  dplyr::select(-record_id)
  #Plot
  ggplot(aes(n, value, group = variable, fill = age.group)) +
    geom_col(stat = 'identity', position = 'dodge') +
  facet_grid(rows = vars(variable))
``

## AgeGender
```{r fig.width=8}

# record_id, gender.factor, age.group,
#                 Homeless.dinamic, id_status.factor.bool,
#                 oms_status.factor.bool, sn_status.factor.bool,
#                 ObsNum

ggGender <-
  data_done %>%
  dplyr::filter(!is.na(gender.factor) & !is.na(age.group)) %>%
  dplyr::group_by(age.group, gender.factor) %>%
  count %>%
  ggplot(aes(n, fct_rev(age.group), fill = gender.factor )) +
  geom_bar(stat = 'identity', position = 'dodge') +
  labs(x = 'Patients', y = 'Age group', fill = 'Gender') +
  scale_fill_manual(values = wes_palettes$Rushmore1[c(3,4)]) +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 14),
        legend.title = element_text(face = 'bold', size = 14),
        axis.text = element_text(size = 12),
        legend.text = element_text(size = 12))
ggGender
```

## AgeHome
```{r fig.width=7}
ggHome <-
  data_done %>%
  dplyr::filter(!is.na(Homeless.dinamic) & !is.na(age.group)) %>%
  dplyr::group_by(age.group, Homeless.dinamic) %>%
  count %>%
  dplyr::group_by(age.group) %>% dplyr::mutate(Sum = sum(n)) %>% dplyr::arrange(desc(Sum)) %>%
  ggplot(aes(n, fct_reorder(Homeless.dinamic, desc(Sum)), fill = age.group )) +
  geom_bar(stat = 'identity') +
  # Appereance
  labs(x = 'Patients', fill = 'Age group', y = 'Home status') +
  scale_fill_manual(values = rev(wes_palettes$Rushmore1)) +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 14),
        legend.title = element_text(face = 'bold', size = 14),
        axis.text = element_text(size = 12),
        legend.text = element_text(size = 12))
ggHome

```

## AgeAlcoNarco
```{r fig.width=10, message = F, warning = F}

  data_done %>%
  dplyr::select(Homeless.dinamic, alcogolic.factor, narco.factor, ne_narco.factor) %>%
  # dplyr::filter(!is.na(age.group)) %>%
  dplyr::group_by(Homeless.dinamic) %>%
  dplyr::summarise(answer = names(table(alcogolic.factor)), # all factors - same value and order
                   Алко = table(alcogolic.factor),
                   Нарко = table(narco.factor),
                   # narco.factor = names(table(narco.factor)),
                   НеНарко = table(ne_narco.factor)
                   # ne_narco.factor = names(table(ne_narco.factor)) 
                   ) %>%
  dplyr::ungroup() %>%
  melt %>%
  dplyr::mutate(value = as.numeric(value))  %>%
  dplyr::group_by(Homeless.dinamic) %>% dplyr::mutate(Sum = sum(value)) %>% dplyr::ungroup() %>%
  
  ggplot(aes(value, answer, fill = Homeless.dinamic)) +
  geom_bar(stat = 'identity') +
  facet_grid(cols = vars(variable)) +
  # Appereance
  labs(x = 'Patients', fill = 'Home status', y = 'Answer') +
  # scale_fill_manual(values = c(wes_palettes$BottleRocket2, wes_palettes$BottleRocket1)) +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 14),
        legend.title = element_text(face = 'bold', size = 14),
        axis.text = element_text(size = 12),
        legend.text = element_text(size = 12),
        strip.text.x = element_text(face = 'bold', size = 14))
  
  
  
  

  
```


# Plot quant vs quant
```{r fig.width=10, fig.height=7}

plot_quant_vs_quant <- function(df, var1, var2, cor.method = 'pearson', dropNA = F){
  # Specify main vars:
  colors.vars <- wes_palettes$Zissou1[c(1,5)]
  # Rename 
  df %<>%
    dplyr::rename('var1' = !!var1, 'var2' = !!var2) %>%
    { `if`(dropNA, na.omit(.), .)}
  
  
  # Basic stats
  ggStats <-
    df %>%
      dplyr::select(var1, var2) %>%
      # setNames(c(var1, var2)) %>%
      summary %>%
      tableGrob()
  
  # Plot distributions
  ggBox1 <- 
    df %>%  
    ggplot(aes(var1)) +
            geom_boxplot(fill = colors.vars[1])
  ggBox2 <- 
    df %>%  
    ggplot(aes(var2)) +
            geom_boxplot(fill = colors.vars[2])
  
  
  # Scatter plot
  ggScatter <-
    df %>%
      # Plot
      ggplot(aes(var1, var2)) +
          geom_point() +
          geom_smooth(method = 'lm') +
          stat_cor(method = cor.method, label.y.npc="top", label.x.npc = "left") +
          labs(caption = paste0('var1: ', var1,'\n',
                                  'var2: ', var2))
  
  return(grid.arrange(ggBox1, ggStats, ggBox2, ggScatter, nrow = 2, ncol = 2))
}


var1 = 'age.actual'
var2 = 'ch_ds.number'
data_done %>%
  plot_quant_vs_quant(var1 , var2, cor.method = 'spearman', dropNA = T)
```

# Plot factor vs factor
```{r fig.width=6, fig.height=6}
# Function for ordinal encoding
encode_ordinal <- function(x, order = sort(unique(x))) {
  x <- as.numeric(factor(x, levels = order, exclude = NULL))
  as.factor(x)
}

plot_factor_vs_factor <- function(df.raw, var1, var2, dropNA = F, original.names = T){
  # Specify main vars:
  colors.vars <- wes_palettes$Zissou1[c(1,5)]
  # Rename 
  df.raw %<>%
    dplyr::rename('var1' = !!var1, 'var2' = !!var2) %>%
    { `if`(dropNA, na.omit(.), .)}
  # Encode if needed
  if(!original.names){
    df <- df.raw %>% dplyr::mutate_all(encode_ordinal)
  }else {
    df <- df.raw
  }
    
  # Basic stats
  ggStats <-
    df %>%
      dplyr::select(var1, var2) %>%
      # Plot
      ggplot() +
        geom_mosaic(aes(x = product(var1, var2)), fill = colors.vars[1]) +
        geom_mosaic_text(aes(x = product(var1, var2), label = after_stat(.wt)), as.label=TRUE) +
        {if(!original.names) labs(caption = paste0('var1: ', var1,': \n', 
                      paste(paste0(sort(unique(encode_ordinal(df.raw$var1))), ' - ', sort(unique(df.raw$var1))), 
                            collapse = '\n'),
                      '\n\n',
                      'var2: ', var2,': \n',
                      paste(paste0(sort(unique(encode_ordinal(df.raw$var2))), ' - ', sort(unique(df.raw$var2))),
                            collapse = '\n')))
          } +
        {if(original.names) labs(x = var2, y = var1)} +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
              plot.caption = element_text(size = 10))
    
  grid.arrange(ggStats)
}

var1 = 'nicotin.factor'
var2 =  'alcogolic.factor'
plot_factor_vs_factor(data_done, var1, var2, 
                      dropNA = T, 
                      original.names = T) #TODO convert all to NA or all to No anwser
```

# Plot quant vs factor
```{r fig.width=10, fig.height=5}
extract_all_comparisons <- function(.tbl) {
  .tbl %>%
    dplyr::select(.data$group1, .data$group2) %>%
    purrr::transpose() %>%
    purrr::modify_depth(1, unlist)
}

plot_quant_vs_factor <- function(df.raw, var1, var2, 
                                 dropNA = F, original.names = T,
                                 compare_mean_method = 't.test'){
  # Specify main vars:
  colors.vars <- wes_palettes$Zissou1[c(1,5)]
  # Figure out what var is factor
  if(is.factor(df.raw[[var1]]) | is.character(df.raw[[var1]])) {
    var.factor = var1
    var.quant = var2
  }else{
    var.quant = var1
    var.factor = var2
  }
  # Rename 
  df.raw %<>%
    dplyr::rename('var.quant' = !!var.quant, 'var.factor' = !!var.factor) %>%
    { `if`(dropNA, na.omit(.), .)}
  
  # Encode if needed
  if(!original.names){
    df <- df.raw %>% dplyr::mutate(var.factor = encode_ordinal(var.factor))
  }else {
    df <- df.raw
  }
  
  # Basic stats
  ggStats <-
    df %>%
      dplyr::select(var.quant, var.factor) %>%
      {`if`(original.names, setNames(., c(var.quant, var.factor)), .)} %>%
      summary %>%
      tableGrob()
  
  # Plot box
  # Calculate combinations of factors
  combinations = lapply(combn(na.omit(unique(df$var.factor)), 2, simplify = F), 
                        as.character)
  
  # ggBox <-
    df %>%  
    ggplot(aes(y= var.quant, x = var.factor, fill = var.factor)) +
            geom_boxplot() +
            geom_jitter(alpha = 0.2, width = 0.05) +
            stat_compare_means(aes(x = var.factor, y = var.quant, label = ..p.adj..),
                               method = compare_mean_method, 
                               comparisons = combinations,
                               na.rm = T) +
            # Appearance
            theme(axis.ticks.x = element_blank(),
                    axis.text.x = element_blank()) +
            {if(!original.names) labs(caption = paste0(
              'var.quant: ', var.quant, '\n\n',
              'var.factor: ', var.factor, '\n', # Add info if encoded
              paste(paste0(sort(unique(encode_ordinal(df.raw$var.factor))), ' - ',
                           sort(unique(df.raw$var.factor))), collapse = '\n')
              ))
            } +
            {if(original.names) labs(x = var.factor,
                                     y = var.quant,
                                     fill = var.factor)} # Add original names
  
  # return(grid.arrange(ggStats, ggBox, ncol = 2))
}

var1 = 'age.actual'
var2 = 'alcogolic.factor'
plot_quant_vs_factor(data_done, 
                     var1, var2, 
                     dropNA = T, 
                     original.names = F,
                     compare_mean_method = 't.test')
```


# Shiny
```{r}
ui <-  fluidPage(
  
  titlePanel(h1("Charity Hospital Project")),
  
  sidebarLayout(
      sidebarPanel(h1("Choosing variables", align = 'center'),
                    
                  selectInput("var1", label = h3("Select first variable"), 
                              choices = selected_vars, 
                              selected = 1),
                  
                  selectInput("var2", label = h3("Select second variable"), 
                              choices = selected_vars, 
                              selected = 1),
                  
                  selectInput("dropNA", label = h3("Drop NA or not?"), 
                              choices = c(T, F), 
                              selected = 1),
                  
                  selectInput("original.names", label = h3("Original names?"),
                              choices = c(T, F),
                              selected = 1),
                  
                  selectInput("means.method", label = h3("Which test use to compare means?"), 
                              choices = c('wilcox.test', 't.test'), 
                              selected = 1),
                  
                  selectInput("cor.method", label = h3("Which correlation test to use?"), 
                              choices = c('spearman', 'pearson'), 
                              selected = 1)
                  ),
      
      mainPanel(h1("Plots", align = 'center'),
                plotOutput(outputId = "plot"))
  )
  
)

server <- function(input, output) {
  
  output$plot <- renderPlot({
    
    vars = c(input$var1, input$var2)
    
    if(is.factor(data_done[[vars[1]]]) & is.factor(data_done[[vars[2]]])){
      # if both are factors
      return(plot_factor_vs_factor(data_done, vars[1], vars[2], 
                                   dropNA = input$dropNA,
                                   original.names = T
                                   ))
    }

    if((is.numeric(data_done[[vars[1]]]) & is.factor(data_done[[vars[2]]])) | 
       is.factor(data_done[[vars[2]]]) & is.factor(data_done[[vars[1]]])){
       # if factor vs quant
       return(plot_quant_vs_factor(data_done, vars[1], vars[2],
                         dropNA = input$dropNA,  
                         original.names = T,
                         compare_mean_method = input$means.method))
    }
    
    if(is.numeric(data_done[[vars[1]]]) & is.numeric(data_done[[vars[2]]])){
      # if both are factors
      return(plot_quant_vs_quant(data_done, vars[1], vars[2],
                                 dropNA = input$dropNA,
                                 cor.method = input$cor.method))
    }
    
    })
    
    
  
}

# Run the app ----
shinyApp(ui = ui, server = server)
```


```{r}

```

data_done %>%
      dplyr::select(!!vars) %>%
      dplyr::rename()
      dplyr::mutate_all(encode_ordinal) %>%
      ggplot() +
  geom_mosaic(aes(x = product(data_done[vars[1]], data_done[vars[2]])))


mosaic2_examp <- ggplot(data = flights) +
  geom_mosaic(aes(x=product(eliminate_reclining, do_you_recline, rude_to_recline), fill = do_you_recline, alpha = eliminate_reclining)) + 
  scale_alpha_manual(values =c(.7,.9)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) + 
  labs(y="Do you recline?", x="Eliminate reclining?:Is it rude to recline?", title = "Mosaic Plot (3 variables)")

fly
data("HairEyeColor")

mosaic(HairEyeColor, shade = TRUE, legend = TRUE)



unique(encode_ordinal(data_done$nicotin.factor))
unique(data_done$nicotin.factor)

sum(is.na(data_done$nicotin.factor))
```

# Plot dummy
```{r}
var1 = dummy_quant_vars[1]
var2 = dummy_quant_vars[2]

data_done %>%
    dplyr::select(!!var1, !!var2) %>%
    melt %>%
  # Plot
    ggplot(aes_string('variable', 'value', fill = 'variable')) +
  geom_boxplot() +
  stat_compare_means() +
  # Appereance
  scale_fill_manual(values = wes_palettes$Zissou1[c(1,5)]) +
  theme(legend.position = 'none')

```

```{r}
data$redcap_repeat_instrument
data %>%
  dplyr::filter(is.na(redcap_repeat_instrument)) %>%
  dplyr::filter(is.na(id_status)) %>%
  dplyr::select(record_id, gender, citizen, id_status, id_status.factor) #%>%
  dplyr::filter(record_id == 1680)
  data$cit
```


                                    # FOR DUMMY VARIABLES::
# data_done %>%
#     dplyr::select(!!var1, !!var2) %>%
#     melt %>%
#   # Plot
#     ggplot(aes_string('variable', 'value', fill = 'variable')) +
#   geom_boxplot() +
#   stat_compare_means() + 
#   # Appereance
#   scale_fill_manual(values = wes_palettes$Zissou1[c(1,5)]) +
#   theme(legend.position = 'none')
```

```{r}
data_done %>% 
  dplyr::select(quant_vars) %>% str
```

- пол (`gender`) - 
наличие документов (`id_status`) - 
места ночлега (`where_homless`) - 
диагноз по МКБ-10 #1 (`ds_icd_1`) - 
диагноз по МКБ-10 #2 (`ds_icd_2`) - 
диагноз по МКБ-10 #3 (`ds_icd_3`) - 
социально-значимые заболевания: - ВИЧ-инфекция (`hiv_1`) - 
Гепатит B (`hb_1`) - 
Гепатит C (`hc_1`) - 
Сифилис (`lues`) - 
Анамнез со слов по ТБ (`tbi`) 
